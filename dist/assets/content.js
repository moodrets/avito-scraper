let t=null;const s={profileName:".desktop-1r4tu1s",profileReviewsCount:".desktop-fgq05w",profileRating:'[data-marker="profile/score"]',profileSubscribers:'[data-marker="favorite-seller-counters"]',profileDeviveryInfo:".Sidebar-root-h24MJ .ProfileBadge-root-bcR8G:nth-child(2)",reviewsItem:".style-snippet-E6g8Y",reviewsItemProductName:".desktop-35wlrd",reviewsItemDateDelivery:".desktop-11ffzh3",reviewsItemRatingStars:".RatingStars-root-Edhhx .Attributes-yellow-star-PY9XT",reviewsMoreLoadButton:'[data-marker="rating-list/moreReviewsButton"]',reviewsSummaryButton:'[data-marker="profile/summary"]',reviewsModal:'[data-marker="profile-rating-detailed/popup"]',reviewsMoreLoadErrorButton:'[data-marker="errorMessage/button"]'};async function u(a){await chrome.runtime.sendMessage(a)}async function m(a){return new Promise(e=>{setTimeout(()=>{e(!0)},a)})}function g(){window.scrollTo({left:0,top:document.body.scrollHeight,behavior:"smooth"})}async function p(a){const e=document.querySelector(s.profileName),r=document.querySelector(s.profileReviewsCount),n=document.querySelector(s.profileRating),o=document.querySelector(s.profileSubscribers),l=document.querySelector(s.profileDeviveryInfo);let c=o!=null&&o.textContent?o.textContent.split(",")[0]:null;const i={parsingDate:Date.now(),name:(e==null?void 0:e.textContent)||"Информация не найдена",rating:(n==null?void 0:n.textContent)||"Информация не найдена",reviewsCount:(r==null?void 0:r.textContent)||"Информация не найдена",subscribers:c||"Информация не найдена",deliveryInfo:(l==null?void 0:l.textContent)||"Информация не найдена",url:a.profileLink};await u({toastType:"success",toastText:"Получена информация профиля",profileInform:i})}const y={getDateOrDeliveryText(a,e){let r=a.split(",");return r[0]&&e==="date"?r[0]:r[1]&&e==="delivery"?r[1]:null},makeMonthNumberFromText(a){let e="";switch(a){case"января":e="01";break;case"февраля":e="02";break;case"марта":e="03";break;case"апреля":e="04";break;case"мая":e="05";break;case"июня":e="06";break;case"июля":e="07";break;case"августа":e="08";break;case"сентября":e="09";break;case"октября":e="10";break;case"ноября":e="11";break;case"декабря":e="12";break}return e},makeDateFromReviewString(a){if(a.trim()==="сегодня")return Date.now();if(a.trim()==="вчера")return new Date().setDate(new Date().getDate()-1);let e=a.split(" "),r=e[0],n=this.makeMonthNumberFromText(e[1]),o=e[2]||`${new Date().getFullYear()}`;return Date.parse(`${o} ${n} ${r}`)},makeDateFromFilterString(a){let e=a.split("."),r=e[0],n=e[1],o=e[2];return Date.parse(`${o} ${n} ${r}`)},get loadMoreButton(){return document.querySelector(s.reviewsMoreLoadButton)},get summaryButton(){return document.querySelector(s.reviewsSummaryButton)},get modal(){return document.querySelector(s.reviewsModal)},getFilteredList(a){let e=[...a];return t!=null&&t.dateFrom&&(t!=null&&t.dateTo)&&(e=e.filter(r=>{if(t!=null&&t.dateFrom&&(t!=null&&t.dateTo)&&r.date>=this.makeDateFromFilterString(t.dateFrom)&&r.date<=this.makeDateFromFilterString(t.dateTo))return r})),t!=null&&t.ratingFrom&&(t!=null&&t.ratingTo)&&(e=e.filter(r=>{if(t!=null&&t.ratingFrom&&(t!=null&&t.ratingTo)&&r.rating>=(t==null?void 0:t.ratingFrom)&&r.rating<=(t==null?void 0:t.ratingTo))return r})),t!=null&&t.productName&&(e=e.filter(r=>{let n=r.productName.toLowerCase(),o=t.productName.toLowerCase();if(n.includes(o))return r})),t!=null&&t.deliveryOnly&&(e=e.filter(r=>r.delivery)),e},async parseItems(){const a=[],e=document.querySelectorAll(s.reviewsItem);let r=!1;if(!e.length){await u({action:"reviews-parsing-ended",toastType:"error",toastText:"Отзывы не найдены"});return}e.forEach(o=>{const l=o.querySelectorAll(s.reviewsItemRatingStars),c=o.querySelector(s.reviewsItemProductName),i=o.querySelector(s.reviewsItemDateDelivery);let f=null,d=null,w=null;i!=null&&i.textContent&&(d=this.getDateOrDeliveryText(i.textContent,"date")),i!=null&&i.textContent&&(f=this.getDateOrDeliveryText(i.textContent,"delivery")),d&&(w=this.makeDateFromReviewString(d)),(!d||!w)&&(r=!0),a.push({date:w||0,dateText:d||"Информация не найдена",delivery:!!f,productName:(c==null?void 0:c.textContent)||"Информация не найдена",rating:(l==null?void 0:l.length)||0})}),r&&await u({action:"reviews-parsing-ended",toastType:"error",toastText:"Не найдены селекторы в отзывах"});const n=this.getFilteredList(a);await u({action:"reviews-parsing-ended",toastType:"success",toastText:"Парсинг отзывов завершен",reviewsFilteredList:n})},async loadMoreInModal(){},async loadMoreOnPage(){if(g(),await m(2e3),this.loadMoreButton&&(this.loadMoreButton.click(),this.loadMoreOnPage()),!this.loadMoreButton){if(await m(2e3),this.loadMoreButton){this.loadMoreOnPage();return}g(),this.parseItems()}},async parsingStart(){var a;if(await u({action:"reviews-parsing-started",toastType:"success",toastText:"Парсинг отзывов запущен"}),(a=this.summaryButton)==null||a.click(),await m(3500),this.modal){this.loadMoreInModal();return}g(),await m(2e3),this.loadMoreOnPage()}};chrome.runtime.onMessage.addListener(async({action:a,filterFields:e})=>{if(!e){await u({toastType:"success",toastText:"Страница не получила поля фильтра"});return}a==="reviews-parsing-start"&&e&&(t=e,p(e),y.parsingStart())});

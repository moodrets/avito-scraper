var k=Object.defineProperty;var v=(i,e,t)=>e in i?k(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var u=(i,e,t)=>(v(i,typeof e!="symbol"?e+"":e,t),t);async function d(i){await chrome.runtime.sendMessage(i)}async function c(i){return new Promise(e=>{setTimeout(()=>{e(!0)},i)})}function y(){let i=Math.floor(Math.random()*256-1),e=Math.floor(Math.random()*256-1),t=Math.floor(Math.random()*256-1),r=(i*299+e*587+t*114)/1e3,s=(255*299+255*587+255*114)/1e3,a=(0*299+0*587+0*114)/1e3;return{text:Math.abs(r-s)>Math.abs(r-a)?"rgb(255, 255, 255)":"rgb(0, 0, 0)",bg:`rgb(${i},${e},${t})`}}function S(i,e){return Math.floor(Math.random()*(e-i+1))+i}async function F(i){const e={profileName:'.Sidebar-root-h24MJ [data-marker*="name"]',profileReviewsCount:".Sidebar-root-h24MJ .desktop-fgq05w",profileRating:'.Sidebar-root-h24MJ [data-marker="profile/score"]',profileSubscribers:'.Sidebar-root-h24MJ [data-marker="favorite-seller-counters"]',profileAsideInfoItems:".Sidebar-root-h24MJ .ProfileBadge-root-bcR8G",profileActiveAdds:'[data-marker="profile-tab(active)"]',profileActiveAddsNew:".ExtendedProfile-content-JTybB .desktop-11ncndy .desktop-1r4tu1s",profileCompletedAdds:'[data-marker="profile-tab(closed)"]'};let t=document.querySelector(e.profileName),r=document.querySelector(e.profileReviewsCount),s=document.querySelector(e.profileRating),a=document.querySelector(e.profileSubscribers),l=[...document.querySelectorAll(e.profileAsideInfoItems)].find(C=>{var h;return(h=C.textContent)==null?void 0:h.includes("продаж")}),o=document.querySelector(e.profileActiveAdds),f=document.querySelector(e.profileActiveAddsNew),n=document.querySelector(e.profileCompletedAdds),m=a!=null&&a.textContent?a.textContent.split(",")[0]:null,g=o!=null&&o.textContent?o.textContent.replace(/\D/g,""):null,w=f!=null&&f.textContent?f.textContent.replace(/\D/g,""):null,p=n!=null&&n.textContent?n.textContent.replace(/\D/g,""):null,b={name:(t==null?void 0:t.textContent)||"Информация не найдена",rating:(s==null?void 0:s.textContent)||"Информация не найдена",reviewsCount:(r==null?void 0:r.textContent)||"Информация не найдена",subscribers:m||"Информация не найдена",deliveryInfo:(l==null?void 0:l.textContent)||"Нет продаж с Авито Доставкой",activeAdds:g||w||"Информация не найдена",completedAdds:p||"",parsingDate:Date.now(),reviewsSortedBy:"product_name_asc",url:i,opened:!1,loading:!1,marked:!1,comment:"",color:y()};await d({action:"profile-info",status:"success",currentUrl:i,messsage:"Получена информация профиля",data:b})}async function R(){const i={categoriesShowButton:'[data-marker="top-rubricator/all-categories"]',categoriesRootItem:'[data-marker*="top-rubricator/root-category"]',categoriesLinksWrapper:".new-rubricator-content-rightContent-zbUZa",categoriesMoreLoadButton:'[data-marker="top-rubricator/more-button"]'};let e={},t=["личные вещи","хобби и отдых","электроника","для дома и дачи","животные"];await c(1e3);let r=document.querySelector(i.categoriesShowButton);r==null||r.click(),await c(500);let s=document.querySelectorAll(i.categoriesRootItem);for(let a of s){let l=a.textContent||"";e[l]=[],a.dispatchEvent(new MouseEvent("mouseover",{view:window,bubbles:!0,cancelable:!0})),await c(200),[...document.querySelectorAll(`${i.categoriesLinksWrapper} a`)].filter((n,m)=>n.textContent.includes("›")&&m!==0).forEach(n=>{e[l].push({text:n.textContent,url:n.href})})}for(const a in e){let l=a.toLocaleLowerCase();t.includes(l)||delete e[a]}await d({action:"set-categories",status:"success",message:"Категории получены",data:e})}class x{constructor(e,t){u(this,"currentURL");u(this,"filterFields");u(this,"offset",0);u(this,"parsingEnded",!1);u(this,"reviewsCollection",[]);this.filterFields=e,this.currentURL=t}makeDateFromFilterString(e){let t=e.split("."),r=t[0],s=t[1],a=t[2];return Date.parse(`${a} ${s} ${r}`)}makeMonthNumberFromText(e){let t="";switch(e){case"января":t="01";break;case"февраля":t="02";break;case"марта":t="03";break;case"апреля":t="04";break;case"мая":t="05";break;case"июня":t="06";break;case"июля":t="07";break;case"августа":t="08";break;case"сентября":t="09";break;case"октября":t="10";break;case"ноября":t="11";break;case"декабря":t="12";break}return t}makeDateFromReviewString(e){if(e.trim()==="сегодня")return Date.now();if(e.trim()==="вчера")return new Date().setDate(new Date().getDate()-1);let t=e.split(" "),r=t[0],s=this.makeMonthNumberFromText(t[1]),a=t[2]||`${new Date().getFullYear()}`;return Date.parse(`${a} ${s} ${r}`)}makeReviewItemData(e){return{date:this.makeDateFromReviewString(e.value.rated),dateText:e.value.rated,delivery:!!e.value.deliveryTitle,productName:e.value.itemTitle,rating:e.value.score,profileUrl:this.currentURL}}getFilteredList(e){let t=[...e];return this.filterFields.dateFrom&&this.filterFields.dateTo&&(t=t.filter(r=>{if(this.filterFields.dateFrom&&this.filterFields.dateTo&&r.date>=this.makeDateFromFilterString(this.filterFields.dateFrom)&&r.date<=this.makeDateFromFilterString(this.filterFields.dateTo))return r})),this.filterFields.ratingFrom&&this.filterFields.ratingTo&&(t=t.filter(r=>{if(this.filterFields.ratingFrom&&this.filterFields.ratingTo&&r.rating>=this.filterFields.ratingFrom&&r.rating<=this.filterFields.ratingTo)return r})),this.filterFields.productName&&(t=t.filter(r=>{let s=r.productName.toLowerCase(),a=this.filterFields.productName.toLowerCase();if(s.includes(a))return r})),this.filterFields.deliveryOnly&&(t=t.filter(r=>r.delivery)),t}async apiGetReviews(e){let t=new URL(this.currentURL),r=new URLSearchParams,l=`https://www.avito.ru/web/5/user/${t.pathname.split("/")[2]}/ratings`;return e==="first"&&r.set("summary_redesign","1"),e==="next"&&(this.offset+=25,r.set("limit","25"),r.set("offset",`${this.offset}`),r.set("sortRating","date_desc"),r.set("summary_redesign","1")),l=`${l}?${r.toString()}`,(await(await fetch(l)).json()).entries.filter(m=>m.type==="rating")||[]}async parseReviews(e){await c(S(3,10)*1e3);try{let t=await this.apiGetReviews(e);this.reviewsCollection.push(...t);let r=this.makeReviewItemData(this.reviewsCollection[this.reviewsCollection.length-1]);if(this.filterFields.dateFrom&&r.date<this.makeDateFromFilterString(this.filterFields.dateFrom)&&(this.parsingEnded=!0),this.parsingEnded){let s=[];for(let l of this.reviewsCollection){let o=this.makeReviewItemData(l);s.push(o)}let a=this.getFilteredList(s);await d({action:"reviews-parsing-ended",status:"success",currentUrl:this.currentURL,data:a})}else this.parseReviews("next")}catch{await d({action:"reviews-parsing-ended",status:"error",currentUrl:this.currentURL,message:"Ошибка запроса отзывов"})}finally{}}async parsingStart(){await d({action:"reviews-parsing-started",status:"success",currentUrl:this.currentURL}),this.parseReviews("first")}}class L{constructor(e,t){u(this,"SELECTORS",{filterDeliveryCheckbox:'.form-form-bRZ7C [data-marker="delivery-filter"] input',filterNewCheckbox:".form-form-bRZ7C span",filterRatingCheckbox:".form-form-bRZ7C span",filterDescInput:'.form-form-bRZ7C input[placeholder="Что-то важное для вас"]',filterSubmitButton:'button[data-marker="search-filters/submit-button"]'});u(this,"currentURL");u(this,"filterFields");this.filterFields=e,this.currentURL=t}async filterSubmitTrigger(){var t;await c(2e3);let e=document.querySelector(this.SELECTORS.filterSubmitButton);if((t=e==null?void 0:e.textContent)!=null&&t.includes("не найдено")){await d({action:"profiles-search-filter-not-found",status:"error"});return}if(e&&e.querySelectorAll("span").length>1){this.filterSubmitTrigger();return}e&&(await d({action:"profiles-search-filter-installed",status:"success",currentUrl:this.currentURL}),e.click())}async setCategoryPageFilter(){var s,a;await c(1e3);let e=document.querySelector(this.SELECTORS.filterDeliveryCheckbox),t=(s=[...document.querySelectorAll(this.SELECTORS.filterNewCheckbox)].find(l=>{var o;return(o=l.textContent)==null?void 0:o.includes("овое")}))==null?void 0:s.parentElement,r=(a=[...document.querySelectorAll(this.SELECTORS.filterRatingCheckbox)].find(l=>{var o;return(o=l.textContent)==null?void 0:o.includes("звезды")}))==null?void 0:a.parentElement;e&&e.click(),t&&t.click(),r&&r.click(),this.filterSubmitTrigger()}}chrome.runtime.onMessage.addListener(async({action:i,currentUrl:e,reviewsFilterFields:t,profilesFilterFields:r})=>{if(i==="get-categories"){await c(1e3),R();return}if(i==="profiles-search-set-filter"){await c(1e3),new L(r,e).setCategoryPageFilter();return}i==="profiles-search-parsing-start"&&(await c(1e3),alert("samsa")),i==="reviews-parsing-start"&&t&&(await c(1e3),F(e),new x(t,e).parsingStart())});

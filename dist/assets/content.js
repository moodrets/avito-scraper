var y=Object.defineProperty;var C=(o,r,e)=>r in o?y(o,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[r]=e;var w=(o,r,e)=>(C(o,typeof r!="symbol"?r+"":r,e),e);let t=null,c="";const l={profileName:'.Sidebar-root-h24MJ [data-marker*="name"]',profileReviewsCount:".Sidebar-root-h24MJ .desktop-fgq05w",profileRating:'.Sidebar-root-h24MJ [data-marker="profile/score"]',profileSubscribers:'.Sidebar-root-h24MJ [data-marker="favorite-seller-counters"]',profileAsideInfoItems:".Sidebar-root-h24MJ .ProfileBadge-root-bcR8G",profileActiveAdds:'[data-marker="profile-tab(active)"]',profileActiveAddsNew:".ExtendedProfile-content-JTybB .desktop-11ncndy .desktop-1r4tu1s",profileCompletedAdds:'[data-marker="profile-tab(closed)"]',reviewsItem:".style-snippet-E6g8Y",reviewsItemProductName:".desktop-35wlrd",reviewsItemDateDelivery:".desktop-11ffzh3",reviewsItemRatingStars:".RatingStars-root-Edhhx .Attributes-yellow-star-PY9XT",reviewsMoreLoadButton:'[data-marker="rating-list/moreReviewsButton"]',reviewsMoreLoadButtonError:'[data-marker="errorMessage/button"]',reviewsSummaryButton:'[data-marker="profile/summary"]',reviewsModal:'[data-marker="profile-rating-detailed/popup"]',reviewsModalScroller:".desktop-y382as",reviewsModalScrollerInner:".style-root-qXsDs",categoriesShowButton:'[data-marker="top-rubricator/all-categories"]',categoriesRootItem:'[data-marker*="top-rubricator/root-category"]',categoriesLinksWrapper:".new-rubricator-content-rightContent-zbUZa",categoriesMoreLoadButton:'[data-marker="top-rubricator/more-button"]',addListFilterDeliveryCheckbox:'.form-form-bRZ7C [data-marker="delivery-filter"] input[type="checkbox"]',addListFilterRatingCheckbox:".form-form-bRZ7C",addListFilterDescInput:'.form-form-bRZ7C input[placeholder="Что-то важное для вас"]',addListFilterSubmitButton:'.form-form-bRZ7C [data-marker="search-filters/submit-button"]'};async function f(o){await chrome.runtime.sendMessage(o)}async function m(o){return new Promise(r=>{setTimeout(()=>{r(!0)},o)})}function x(){let o=Math.floor(Math.random()*256-1),r=Math.floor(Math.random()*256-1),e=Math.floor(Math.random()*256-1),a=(o*299+r*587+e*114)/1e3,s=(255*299+255*587+255*114)/1e3,i=(0*299+0*587+0*114)/1e3;return{text:Math.abs(a-s)>Math.abs(a-i)?"rgb(255, 255, 255)":"rgb(0, 0, 0)",bg:`rgb(${o},${r},${e})`}}function M(o,r){return Math.floor(Math.random()*(r-o+1))+o}async function A(){let o=document.querySelector(l.profileName),r=document.querySelector(l.profileReviewsCount),e=document.querySelector(l.profileRating),a=document.querySelector(l.profileSubscribers),s=[...document.querySelectorAll(l.profileAsideInfoItems)].find(k=>{var h;return(h=k.textContent)==null?void 0:h.includes("продаж")}),i=document.querySelector(l.profileActiveAdds),n=document.querySelector(l.profileActiveAddsNew),d=document.querySelector(l.profileCompletedAdds),u=a!=null&&a.textContent?a.textContent.split(",")[0]:null,g=i!=null&&i.textContent?i.textContent.replace(/\D/g,""):null,p=n!=null&&n.textContent?n.textContent.replace(/\D/g,""):null,v=d!=null&&d.textContent?d.textContent.replace(/\D/g,""):null,b={name:(o==null?void 0:o.textContent)||"Информация не найдена",rating:(e==null?void 0:e.textContent)||"Информация не найдена",reviewsCount:(r==null?void 0:r.textContent)||"Информация не найдена",subscribers:u||"Информация не найдена",deliveryInfo:(s==null?void 0:s.textContent)||"Нет продаж с Авито Доставкой",activeAdds:g||p||"Информация не найдена",completedAdds:v||"",parsingDate:Date.now(),reviewsSortedBy:"product_name_asc",url:c,opened:!1,loading:!1,marked:!1,comment:"",color:x()};await f({action:"profile-info",status:"success",currentUrl:c,messsage:"Получена информация профиля",data:b})}async function q(){let o={},r=["личные вещи","хобби и отдых","электроника","для дома и дачи","животные"];await m(1e3);let e=document.querySelector(l.categoriesShowButton);e==null||e.click(),await m(500);let a=document.querySelectorAll(l.categoriesRootItem);for(let s of a){let i=s.textContent||"";o[i]=[],s.dispatchEvent(new MouseEvent("mouseover",{view:window,bubbles:!0,cancelable:!0})),await m(500);let n=document.querySelectorAll(`${l.categoriesLinksWrapper} ${l.categoriesMoreLoadButton}`);for(const u of n)u.click();await m(500),document.querySelectorAll(`${l.categoriesLinksWrapper} a`).forEach(u=>{o[i].push({text:u.textContent,url:u.href})})}for(const s in o){let i=s.toLocaleLowerCase();r.includes(i)||delete o[s]}await f({action:"get-categories",status:"success",currentUrl:c,message:"Категории получены",data:o})}class N{constructor(){w(this,"offset",0);w(this,"parsingEnded",!1);w(this,"reviewsCollection",[])}makeDateFromFilterString(r){let e=r.split("."),a=e[0],s=e[1],i=e[2];return Date.parse(`${i} ${s} ${a}`)}makeMonthNumberFromText(r){let e="";switch(r){case"января":e="01";break;case"февраля":e="02";break;case"марта":e="03";break;case"апреля":e="04";break;case"мая":e="05";break;case"июня":e="06";break;case"июля":e="07";break;case"августа":e="08";break;case"сентября":e="09";break;case"октября":e="10";break;case"ноября":e="11";break;case"декабря":e="12";break}return e}makeDateFromReviewString(r){if(r.trim()==="сегодня")return Date.now();if(r.trim()==="вчера")return new Date().setDate(new Date().getDate()-1);let e=r.split(" "),a=e[0],s=this.makeMonthNumberFromText(e[1]),i=e[2]||`${new Date().getFullYear()}`;return Date.parse(`${i} ${s} ${a}`)}makeReviewItemData(r){return{date:this.makeDateFromReviewString(r.value.rated),dateText:r.value.rated,delivery:!!r.value.deliveryTitle,productName:r.value.itemTitle,rating:r.value.score,profileUrl:c}}getFilteredList(r){let e=[...r];return t!=null&&t.dateFrom&&(t!=null&&t.dateTo)&&(e=e.filter(a=>{if(t!=null&&t.dateFrom&&(t!=null&&t.dateTo)&&a.date>=this.makeDateFromFilterString(t.dateFrom)&&a.date<=this.makeDateFromFilterString(t.dateTo))return a})),t!=null&&t.ratingFrom&&(t!=null&&t.ratingTo)&&(e=e.filter(a=>{if(t!=null&&t.ratingFrom&&(t!=null&&t.ratingTo)&&a.rating>=(t==null?void 0:t.ratingFrom)&&a.rating<=(t==null?void 0:t.ratingTo))return a})),t!=null&&t.productName&&(e=e.filter(a=>{let s=a.productName.toLowerCase(),i=t.productName.toLowerCase();if(s.includes(i))return a})),t!=null&&t.deliveryOnly&&(e=e.filter(a=>a.delivery)),e}async apiGetReviews(r){let e=new URL(c),a=new URLSearchParams,n=`https://www.avito.ru/web/5/user/${e.pathname.split("/")[2]}/ratings`;return r==="first"&&a.set("summary_redesign","1"),r==="next"&&(this.offset+=25,a.set("limit","25"),a.set("offset",`${this.offset}`),a.set("sortRating","date_desc"),a.set("summary_redesign","1")),n=`${n}?${a.toString()}`,(await(await fetch(n)).json()).entries.filter(p=>p.type==="rating")||[]}async parseReviews(r){await m(M(3,10)*1e3);try{let e=await this.apiGetReviews(r);this.reviewsCollection.push(...e);let a=this.makeReviewItemData(this.reviewsCollection[this.reviewsCollection.length-1]);if(t!=null&&t.dateFrom&&a.date<this.makeDateFromFilterString(t==null?void 0:t.dateFrom)&&(this.parsingEnded=!0),this.parsingEnded){let s=[];for(let n of this.reviewsCollection){let d=this.makeReviewItemData(n);s.push(d)}let i=this.getFilteredList(s);await f({action:"reviews-parsing-ended",status:"success",currentUrl:c,data:i})}else this.parseReviews("next")}catch{await f({action:"reviews-parsing-ended",status:"error",currentUrl:c,message:"Ошибка запроса отзывов"})}finally{}}async parsingStart(){await f({action:"reviews-parsing-started",status:"success",currentUrl:c}),this.parseReviews("first")}}chrome.runtime.onMessage.addListener(async({action:o,reviewsFilterFields:r,currentUrl:e})=>{if(o==="get-categories"){await m(1e3),q();return}if(!r){await f({action:"reviews-parsing-ended",status:"error",currentUrl:c,message:"Страница не получила поля фильтра"});return}o==="reviews-parsing-start"&&r&&(await m(1e3),c=e,t=r,t&&A(),new N().parsingStart())});

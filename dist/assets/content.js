var S=Object.defineProperty;var b=(i,e,t)=>e in i?S(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var n=(i,e,t)=>(b(i,typeof e!="symbol"?e+"":e,t),t);async function u(i){await chrome.runtime.sendMessage(i)}async function f(i){return new Promise(e=>{setTimeout(()=>{e(!0)},i)})}function C(){let i=Math.floor(Math.random()*256-1),e=Math.floor(Math.random()*256-1),t=Math.floor(Math.random()*256-1),r=(i*299+e*587+t*114)/1e3,s=(255*299+255*587+255*114)/1e3,a=(0*299+0*587+0*114)/1e3;return{text:Math.abs(r-s)>Math.abs(r-a)?"rgb(255, 255, 255)":"rgb(0, 0, 0)",bg:`rgb(${i},${e},${t})`}}function h(i,e){return Math.floor(Math.random()*(e-i+1))+i}async function L(i){const e={profileName:'.Sidebar-root-h24MJ [data-marker*="name"]',profileReviewsCount:".Sidebar-root-h24MJ .desktop-fgq05w",profileRating:'.Sidebar-root-h24MJ [data-marker="profile/score"]',profileSubscribers:'.Sidebar-root-h24MJ [data-marker="favorite-seller-counters"]',profileAsideInfoItems:".Sidebar-root-h24MJ .ProfileBadge-root-bcR8G",profileActiveAdds:'[data-marker="profile-tab(active)"]',profileActiveAddsNew:".ExtendedProfile-content-JTybB .desktop-11ncndy .desktop-1r4tu1s",profileCompletedAdds:'[data-marker="profile-tab(closed)"]'};let t=document.querySelector(e.profileName),r=document.querySelector(e.profileReviewsCount),s=document.querySelector(e.profileRating),a=document.querySelector(e.profileSubscribers),l=[...document.querySelectorAll(e.profileAsideInfoItems)].find(F=>{var p;return(p=F.textContent)==null?void 0:p.includes("продаж")}),o=document.querySelector(e.profileActiveAdds),c=document.querySelector(e.profileActiveAddsNew),d=document.querySelector(e.profileCompletedAdds),m=a!=null&&a.textContent?a.textContent.split(",")[0]:null,g=o!=null&&o.textContent?o.textContent.replace(/\D/g,""):null,w=c!=null&&c.textContent?c.textContent.replace(/\D/g,""):null,R=d!=null&&d.textContent?d.textContent.replace(/\D/g,""):null,v={name:(t==null?void 0:t.textContent)||"Информация не найдена",rating:(s==null?void 0:s.textContent)||"Информация не найдена",reviewsCount:(r==null?void 0:r.textContent)||"Информация не найдена",subscribers:m||"Информация не найдена",deliveryInfo:(l==null?void 0:l.textContent)||"Нет продаж с Авито Доставкой",activeAdds:g||w||"Информация не найдена",completedAdds:R||"",parsingDate:Date.now(),reviewsSortedBy:"product_name_asc",url:i,opened:!1,loading:!1,marked:!1,comment:"",color:C()};await u({action:"profile-info",status:"success",currentUrl:i,messsage:"Получена информация профиля",data:v})}class y{constructor(e,t){n(this,"currentURL");n(this,"filterFields");n(this,"offset",0);n(this,"parsingEnded",!1);n(this,"reviewsCollection",[]);this.filterFields=e,this.currentURL=t}makeDateFromFilterString(e){let t=e.split("."),r=t[0],s=t[1],a=t[2];return Date.parse(`${a} ${s} ${r}`)}makeMonthNumberFromText(e){let t="";switch(e){case"января":t="01";break;case"февраля":t="02";break;case"марта":t="03";break;case"апреля":t="04";break;case"мая":t="05";break;case"июня":t="06";break;case"июля":t="07";break;case"августа":t="08";break;case"сентября":t="09";break;case"октября":t="10";break;case"ноября":t="11";break;case"декабря":t="12";break}return t}makeDateFromReviewString(e){if(e.trim()==="сегодня")return Date.now();if(e.trim()==="вчера")return new Date().setDate(new Date().getDate()-1);let t=e.split(" "),r=t[0],s=this.makeMonthNumberFromText(t[1]),a=t[2]||`${new Date().getFullYear()}`;return Date.parse(`${a} ${s} ${r}`)}makeReviewItemData(e){return{date:this.makeDateFromReviewString(e.value.rated),dateText:e.value.rated,delivery:!!e.value.deliveryTitle,productName:e.value.itemTitle,rating:e.value.score,profileUrl:this.currentURL}}getFilteredList(e){let t=[...e];return this.filterFields.dateFrom&&this.filterFields.dateTo&&(t=t.filter(r=>{if(this.filterFields.dateFrom&&this.filterFields.dateTo&&r.date>=this.makeDateFromFilterString(this.filterFields.dateFrom)&&r.date<=this.makeDateFromFilterString(this.filterFields.dateTo))return r})),this.filterFields.ratingFrom&&this.filterFields.ratingTo&&(t=t.filter(r=>{if(this.filterFields.ratingFrom&&this.filterFields.ratingTo&&r.rating>=this.filterFields.ratingFrom&&r.rating<=this.filterFields.ratingTo)return r})),this.filterFields.productName&&(t=t.filter(r=>{let s=r.productName.toLowerCase(),a=this.filterFields.productName.toLowerCase();if(s.includes(a))return r})),this.filterFields.deliveryOnly&&(t=t.filter(r=>r.delivery)),t}async apiGetReviews(e){let t=new URL(this.currentURL),r=new URLSearchParams,l=`https://www.avito.ru/web/5/user/${t.pathname.split("/")[2]}/ratings`;return e==="first"&&r.set("summary_redesign","1"),e==="next"&&(this.offset+=25,r.set("limit","25"),r.set("offset",`${this.offset}`),r.set("sortRating","date_desc"),r.set("summary_redesign","1")),l=`${l}?${r.toString()}`,(await(await fetch(l)).json()).entries.filter(m=>m.type==="rating")||[]}async parseReviews(e){await f(h(2,10)*1e3);try{let t=await this.apiGetReviews(e);this.reviewsCollection.push(...t);let r=this.makeReviewItemData(this.reviewsCollection[this.reviewsCollection.length-1]);if(this.filterFields.dateFrom&&r.date<this.makeDateFromFilterString(this.filterFields.dateFrom)&&(this.parsingEnded=!0),this.parsingEnded){let s=[];for(let l of this.reviewsCollection){let o=this.makeReviewItemData(l);s.push(o)}let a=this.getFilteredList(s);await u({action:"reviews-parsing-ended",status:"success",currentUrl:this.currentURL,data:a})}else this.parseReviews("next")}catch{await u({action:"reviews-parsing-ended",status:"error",currentUrl:this.currentURL,message:"Ошибка запроса отзывов"})}finally{}}async parsingStart(){await u({action:"reviews-parsing-started",status:"success",currentUrl:this.currentURL}),this.parseReviews("first")}}class k{constructor(e,t){n(this,"SELECTORS",{profileItem:".iva-item-userInfoStep-dWwGU",profileItemLink:"a",profileItemName:"a p",profileItemRating:'[data-marker="seller-rating/score"]',profileItemReviewsCount:'[data-marker="seller-rating/summary"]'});n(this,"currentURL");n(this,"filterFields");n(this,"currentPageNumber",0);n(this,"profilesCollection",[]);this.filterFields=e,this.currentURL=t}get pagesRange(){let e=this.filterFields.pagesRange.split("-");return{start:e[0],end:e[1]}}getFilteredList(){let e=[...this.profilesCollection];return this.filterFields.reviewsCount&&(e=e.filter(t=>{if(t.reviewsCount>=this.filterFields.reviewsCount)return t})),this.filterFields.profileName&&(e=e.filter(t=>{let r=this.filterFields.profileName.toLowerCase();if(t.name.toLowerCase().includes(r))return t})),e}makeProfileItemData(e){var c;let t=e.querySelector(this.SELECTORS.profileItemLink),r=e.querySelector(this.SELECTORS.profileItemName),s=e.querySelector(this.SELECTORS.profileItemRating),a=e.querySelector(this.SELECTORS.profileItemReviewsCount),l=(c=a==null?void 0:a.textContent)==null?void 0:c.replace(/\D/g,"");return{url:t.href,name:r.textContent||"",rating:s.textContent||"",reviewsCount:l?+l:0}}async parseProfiles(e){await f(h(2,10)*1e3),await this.apiGetAdds(e)}async apiGetAdds(e){e==="first"&&(this.currentPageNumber=+this.pagesRange.start),e==="next"&&(this.currentPageNumber+=1),u({action:"profiles-parsing-current-page",status:"success",currentUrl:this.currentURL,data:this.currentPageNumber});let t=new URL(this.currentURL);t.searchParams.delete("p"),this.currentPageNumber!==1&&t.searchParams.set("p",`${this.currentPageNumber}`);try{let s=await(await fetch(t.toString())).text();new DOMParser().parseFromString(s,"text/html").body.querySelectorAll(this.SELECTORS.profileItem).forEach(o=>{let c=this.makeProfileItemData(o);this.profilesCollection.push(c)}),this.currentPageNumber===+this.pagesRange.end?await u({action:"profiles-parsing-ended",status:"success",currentUrl:this.currentURL,data:this.getFilteredList()}):this.parseProfiles("next")}catch{await u({action:"profiles-parsing-ended",status:"error",currentUrl:this.currentURL})}finally{}}async parsingStart(){await u({action:"profiles-parsing-started",status:"success",currentUrl:this.currentURL}),this.parseProfiles("first")}}chrome.runtime.onMessage.addListener(async({action:i,currentUrl:e,reviewsFilterFields:t,profilesFilterFields:r})=>{if(i==="profiles-parsing-start"){await f(1e3),new k(r,e).parsingStart();return}i==="reviews-parsing-start"&&t&&(await f(1e3),L(e),new y(t,e).parsingStart())});

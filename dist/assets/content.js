var I=Object.defineProperty;var N=(a,t,e)=>t in a?I(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var n=(a,t,e)=>(N(a,typeof t!="symbol"?t+"":t,e),e);function U(a){return a.split("/")[4]}async function f(a){await chrome.runtime.sendMessage(a)}async function p(a){return new Promise(t=>{setTimeout(()=>{t(!0)},a)})}function P(){let a=Math.floor(Math.random()*256-1),t=Math.floor(Math.random()*256-1),e=Math.floor(Math.random()*256-1),r=(a*299+t*587+e*114)/1e3,i=(255*299+255*587+255*114)/1e3,s=(0*299+0*587+0*114)/1e3;return{text:Math.abs(r-i)>Math.abs(r-s)?"rgb(255, 255, 255)":"rgb(0, 0, 0)",bg:`rgb(${a},${t},${e})`}}function g(a,t){return Math.floor(Math.random()*(t-a+1))+a}async function A(a){const t={profileName:'.Sidebar-root-h24MJ [data-marker*="name"]',profileReviewsCount:".Sidebar-root-h24MJ .desktop-fgq05w",profileRating:'.Sidebar-root-h24MJ [data-marker="profile/score"]',profileSubscribers:'.Sidebar-root-h24MJ [data-marker="favorite-seller-counters"]',profileAsideInfoItems:".Sidebar-root-h24MJ .ProfileBadge-root-bcR8G",profileActiveAdds_1:'[data-marker="profile-tab(active)"]',profileActiveAdds_2:'#item_list_with_filters button[type="button"][data-num="0"]',profileActiveAdds_3:"#item_list_with_filters .desktop-1r4tu1s",profileCompletedAdds_1:'#item_list_with_filters button[type="button"][data-num="1"]',profileCompletedAdds_2:'[data-marker="profile-tab(closed)"]'};let e=document.querySelector(t.profileName),r=document.querySelector(t.profileReviewsCount),i=document.querySelector(t.profileRating),s=document.querySelector(t.profileSubscribers),l=[...document.querySelectorAll(t.profileAsideInfoItems)].find(D=>{var h;return(h=D.textContent)==null?void 0:h.includes("продаж")}),o=document.querySelector(t.profileActiveAdds_1),u=document.querySelector(t.profileActiveAdds_2),c=document.querySelector(t.profileActiveAdds_3),d=document.querySelector(t.profileCompletedAdds_1),m=document.querySelector(t.profileCompletedAdds_2),w=s!=null&&s.textContent?s.textContent.split(",")[0]:null,C=o!=null&&o.textContent?o.textContent.replace(/\D/g,""):null,v=u!=null&&u.textContent?u.textContent.replace(/\D/g,""):null,F=c!=null&&c.textContent?c.textContent.replace(/\D/g,""):null,S=d!=null&&d.textContent?d.textContent.replace(/\D/g,""):null,R=m!=null&&m.textContent?m.textContent.replace(/\D/g,""):null,b=i!=null&&i.textContent?i.textContent.replace(",","."):"",y=e!=null&&e.textContent?e.textContent:null,L=r!=null&&r.textContent?r.textContent:null,x=l!=null&&l.textContent?l.textContent:null,k={id:Date.now(),name:y||"Информация не найдена",rating:b||"Информация не найдена",reviewsCount:L||"Информация не найдена",subscribers:w||"Информация не найдена",deliveryInfo:x||"Нет продаж с Авито Доставкой",activeAdds:C||v||F||"Информация не найдена",completedAdds:S||R||"",parsingDate:Date.now(),reviewsSortedBy:"product_name_asc",url:a,opened:!1,loading:!1,marked:!1,comment:"",color:P()};await f({action:"profile-info",status:"success",currentUrl:a,messsage:"Получена информация профиля",data:k})}class _{constructor(t,e){n(this,"currentURL");n(this,"filterFields");n(this,"offset",0);n(this,"parsingEnded",!1);n(this,"reviewsCollection",[]);this.filterFields=t,this.currentURL=e}makeDateFromFilterString(t){let e=t.split("."),r=e[0],i=e[1],s=e[2];return Date.parse(`${s} ${i} ${r}`)}makeMonthNumberFromText(t){let e="";switch(t){case"января":e="01";break;case"февраля":e="02";break;case"марта":e="03";break;case"апреля":e="04";break;case"мая":e="05";break;case"июня":e="06";break;case"июля":e="07";break;case"августа":e="08";break;case"сентября":e="09";break;case"октября":e="10";break;case"ноября":e="11";break;case"декабря":e="12";break}return e}makeDateFromReviewString(t){if(t.trim()==="сегодня")return Date.now();if(t.trim()==="вчера")return new Date().setDate(new Date().getDate()-1);let e=t.split(" "),r=e[0],i=this.makeMonthNumberFromText(e[1]),s=e[2]||`${new Date().getFullYear()}`;return Date.parse(`${s} ${i} ${r}`)}makeReviewItemData(t){return{date:this.makeDateFromReviewString(t.value.rated),dateText:t.value.rated,delivery:!!t.value.deliveryTitle,productName:t.value.itemTitle,rating:t.value.score,profileUrl:this.currentURL}}getFilteredList(t){let e=[...t];return this.filterFields.dateFrom&&this.filterFields.dateTo&&(e=e.filter(r=>{if(this.filterFields.dateFrom&&this.filterFields.dateTo&&r.date>=this.makeDateFromFilterString(this.filterFields.dateFrom)&&r.date<=this.makeDateFromFilterString(this.filterFields.dateTo))return r})),this.filterFields.ratingFrom&&this.filterFields.ratingTo&&(e=e.filter(r=>{if(this.filterFields.ratingFrom&&this.filterFields.ratingTo&&r.rating>=this.filterFields.ratingFrom&&r.rating<=this.filterFields.ratingTo)return r})),this.filterFields.productName&&(e=e.filter(r=>{let i=r.productName.toLowerCase(),s=this.filterFields.productName.toLowerCase();if(i.includes(s))return r})),this.filterFields.deliveryOnly&&(e=e.filter(r=>r.delivery)),e}async apiGetReviews(t){let e=new URLSearchParams,i=`https://www.avito.ru/web/5/user/${U(this.currentURL)}/ratings`;return t==="first"&&e.set("summary_redesign","1"),t==="next"&&(this.offset+=25,e.set("limit","25"),e.set("offset",`${this.offset}`),e.set("sortRating","date_desc"),e.set("summary_redesign","1")),i=`${i}?${e.toString()}`,(await(await fetch(i)).json()).entries.filter(u=>u.type==="rating")||[]}async parseReviews(t){await p(g(2,10)*1e3);try{let e=await this.apiGetReviews(t);this.reviewsCollection.push(...e);let r=this.makeReviewItemData(this.reviewsCollection[this.reviewsCollection.length-1]);if(this.filterFields.dateFrom&&r.date<this.makeDateFromFilterString(this.filterFields.dateFrom)&&(this.parsingEnded=!0),this.parsingEnded){let i=[];for(let l of this.reviewsCollection){let o=this.makeReviewItemData(l);i.push(o)}let s=this.getFilteredList(i);await f({action:"reviews-parsing-ended",status:"success",currentUrl:this.currentURL,data:s}),this.filterFields.closeTabs&&window.close()}else this.parseReviews("next")}catch{await f({action:"reviews-parsing-ended",status:"error",currentUrl:this.currentURL,message:"Ошибка запроса отзывов"})}finally{}}async parsingStart(){await f({action:"reviews-parsing-started",status:"success",currentUrl:this.currentURL}),this.parseReviews("first")}}class T{constructor(t,e){n(this,"SELECTORS",{profileItem:".iva-item-userInfoStep-dWwGU",profileItemLink:"a",profileItemName:"a p",profileItemRating:'[data-marker="seller-rating/score"]',profileItemReviewsCount:'[data-marker="seller-rating/summary"]'});n(this,"currentURL");n(this,"filterFields");n(this,"currentPageNumber",0);n(this,"profilesCollection",[]);this.filterFields=t,this.currentURL=e}getFilteredList(){let t=[...this.profilesCollection];return this.filterFields.reviewsCount&&(t=t.filter(e=>{if(e.reviewsCount>=this.filterFields.reviewsCount)return e})),this.filterFields.profileName&&(t=t.filter(e=>{let r=this.filterFields.profileName.toLowerCase(),i=e.name.toLowerCase();if(i.includes(r)||i===r)return e})),t}makeProfileItemData(t){var c;let e=t.querySelector(this.SELECTORS.profileItemLink),r=t.querySelector(this.SELECTORS.profileItemName),i=t.querySelector(this.SELECTORS.profileItemRating),s=t.querySelector(this.SELECTORS.profileItemReviewsCount),l=(c=s==null?void 0:s.textContent)==null?void 0:c.replace(/\D/g,""),o=i!=null&&i.textContent?parseFloat(i.textContent.replace(",",".")):0;return{url:e.href,name:r.textContent||"",rating:o,reviewsCount:l?+l:0,existsInDataBase:!1}}async parseProfiles(t){await p(g(2,10)*1e3),await this.apiGetAdds(t)}async apiGetAdds(t){var r;t==="first"&&(this.currentPageNumber=+this.filterFields.pageStart),t==="next"&&(this.currentPageNumber+=1),f({action:"profiles-parsing-current-page",status:"success",currentUrl:this.currentURL,data:this.currentPageNumber});let e=new URL(this.currentURL);e.searchParams.delete("p"),this.currentPageNumber!==1&&e.searchParams.set("p",`${this.currentPageNumber}`);try{let s=await(await fetch(e.toString())).text(),l=new DOMParser().parseFromString(s,"text/html"),o=(r=l.querySelector("title"))==null?void 0:r.textContent,u=l.body.querySelectorAll(this.SELECTORS.profileItem);await f({action:"profiles-parsing-category-info",status:"success",data:o||""}),u.forEach(c=>{let d=this.makeProfileItemData(c);this.profilesCollection.push(d)}),this.currentPageNumber===+this.filterFields.pageEnd?await f({action:"profiles-parsing-ended",status:"success",currentUrl:this.currentURL,data:this.getFilteredList()}):this.parseProfiles("next")}catch{await f({action:"profiles-parsing-ended",status:"error",currentUrl:this.currentURL})}finally{}}async parsingStart(){await f({action:"profiles-parsing-started",status:"success",currentUrl:this.currentURL}),this.parseProfiles("first")}}chrome.runtime.onMessage.addListener(async({action:a,currentUrl:t,reviewsFilterFields:e,profilesFilterFields:r})=>{if(a==="profiles-parsing-start"){await p(1e3),new T(r,t).parsingStart();return}a==="reviews-parsing-start"&&e&&(await p(1e3),A(t),new _(e,t).parsingStart())});

let t=null,l="";const s={profileName:".Sidebar-root-h24MJ .desktop-1r4tu1s",profileReviewsCount:".Sidebar-root-h24MJ .desktop-fgq05w",profileRating:'.Sidebar-root-h24MJ [data-marker="profile/score"]',profileSubscribers:'.Sidebar-root-h24MJ [data-marker="favorite-seller-counters"]',profileAsideInfoItems:".Sidebar-root-h24MJ .ProfileBadge-root-bcR8G",reviewsItem:".style-snippet-E6g8Y",reviewsItemProductName:".desktop-35wlrd",reviewsItemDateDelivery:".desktop-11ffzh3",reviewsItemRatingStars:".RatingStars-root-Edhhx .Attributes-yellow-star-PY9XT",reviewsMoreLoadButton:'[data-marker="rating-list/moreReviewsButton"]',reviewsMoreLoadButtonError:'[data-marker="errorMessage/button"]',reviewsSummaryButton:'[data-marker="profile/summary"]',reviewsModal:'[data-marker="profile-rating-detailed/popup"]',reviewsModalScroller:".desktop-y382as",reviewsModalScrollerInner:".style-root-qXsDs",categoriesShowButton:'[data-marker="top-rubricator/all-categories"]'};async function d(r){await chrome.runtime.sendMessage(r)}async function n(r){return new Promise(e=>{setTimeout(()=>{e(!0)},r)})}function f(){window.scrollTo({left:0,top:document.body.scrollHeight,behavior:"smooth"})}function h(r,e){r.scrollTo({top:e,behavior:"smooth"})}function p(){let r=Math.floor(Math.random()*256-1),e=Math.floor(Math.random()*256-1),a=Math.floor(Math.random()*256-1),o=(r*299+e*587+a*114)/1e3,i=(255*299+255*587+255*114)/1e3,u=(0*299+0*587+0*114)/1e3;return{text:Math.abs(o-i)>Math.abs(o-u)?"rgb(255, 255, 255)":"rgb(0, 0, 0)",bg:"rgb("+r+","+e+","+a+")"}}function m(r,e){return Math.floor(Math.random()*(e-r+1))+r}async function M(){let r=document.querySelector(s.profileName),e=document.querySelector(s.profileReviewsCount),a=document.querySelector(s.profileRating),o=document.querySelector(s.profileSubscribers),i=[...document.querySelectorAll(s.profileAsideInfoItems)].find(w=>{var g;return(g=w.textContent)==null?void 0:g.includes("прода")}),u=o!=null&&o.textContent?o.textContent.split(",")[0]:null,c={parsingDate:Date.now(),name:(r==null?void 0:r.textContent)||"Информация не найдена",rating:(a==null?void 0:a.textContent)||"Информация не найдена",reviewsCount:(e==null?void 0:e.textContent)||"Информация не найдена",subscribers:u||"Информация не найдена",deliveryInfo:(i==null?void 0:i.textContent)||"Нет продаж с Авито Доставкой",reviewsSortedBy:"productName",url:l,opened:!1,loading:!1,marked:!1,comment:"",color:p()};await d({action:"profile-info",status:"success",currentUrl:l,messsage:"Получена информация профиля",data:c})}async function v(){document.querySelector(s.categoriesShowButton)}const y={parsingEnded:!1,makeMonthNumberFromText(r){let e="";switch(r){case"января":e="01";break;case"февраля":e="02";break;case"марта":e="03";break;case"апреля":e="04";break;case"мая":e="05";break;case"июня":e="06";break;case"июля":e="07";break;case"августа":e="08";break;case"сентября":e="09";break;case"октября":e="10";break;case"ноября":e="11";break;case"декабря":e="12";break}return e},makeDateFromReviewString(r){if(r.trim()==="сегодня")return Date.now();if(r.trim()==="вчера")return new Date().setDate(new Date().getDate()-1);let e=r.split(" "),a=e[0],o=this.makeMonthNumberFromText(e[1]),i=e[2]||`${new Date().getFullYear()}`;return Date.parse(`${i} ${o} ${a}`)},makeDateFromFilterString(r){let e=r.split("."),a=e[0],o=e[1],i=e[2];return Date.parse(`${i} ${o} ${a}`)},get loadMoreButton(){return document.querySelector(s.reviewsMoreLoadButton)},get loadMoreButtonError(){return document.querySelector(s.reviewsMoreLoadButtonError)},get summaryButton(){return document.querySelector(s.reviewsSummaryButton)},get modal(){return document.querySelector(s.reviewsModal)},getFilteredList(r){let e=[...r];return t!=null&&t.dateFrom&&(t!=null&&t.dateTo)&&(e=e.filter(a=>{if(t!=null&&t.dateFrom&&(t!=null&&t.dateTo)&&a.date>=this.makeDateFromFilterString(t.dateFrom)&&a.date<=this.makeDateFromFilterString(t.dateTo))return a})),t!=null&&t.ratingFrom&&(t!=null&&t.ratingTo)&&(e=e.filter(a=>{if(t!=null&&t.ratingFrom&&(t!=null&&t.ratingTo)&&a.rating>=(t==null?void 0:t.ratingFrom)&&a.rating<=(t==null?void 0:t.ratingTo))return a})),t!=null&&t.productName&&(e=e.filter(a=>{let o=a.productName.toLowerCase(),i=t.productName.toLowerCase();if(o.includes(i))return a})),t!=null&&t.deliveryOnly&&(e=e.filter(a=>a.delivery)),e},makeReviewItemData(r){let e=r.querySelectorAll(s.reviewsItemRatingStars),a=r.querySelector(s.reviewsItemProductName),o=r.querySelector(s.reviewsItemDateDelivery),i=null,u=null,c=null;return o!=null&&o.textContent&&(u=(o==null?void 0:o.textContent.split(",")[0])||null,i=(o==null?void 0:o.textContent.split(",")[1])||null),u&&(c=this.makeDateFromReviewString(u)),{date:c||0,dateText:u||"Информация не найдена",delivery:!!i,productName:(a==null?void 0:a.textContent)||"Информация не найдена",rating:(e==null?void 0:e.length)||0,profileUrl:l}},async parseItems(){this.loadMoreButtonError&&(await n(5e3),this.loadMoreButtonError.click(),await n(3e3));let r=[],e=[...document.querySelectorAll(s.reviewsItem)];try{let a=e[e.length-1],o=this.makeReviewItemData(a);if(!e.length||!a)throw new Error;if(o.date===0)throw new Error;t!=null&&t.dateFrom&&o.date<this.makeDateFromFilterString(t==null?void 0:t.dateFrom)&&(this.parsingEnded=!0)}catch{await d({action:"reviews-parsing-ended",status:"error",currentUrl:l,message:"Не найдены селекторы в отзывах"});return}if(this.parsingEnded){for(let o of e){let i=this.makeReviewItemData(o);r.push(i)}let a=this.getFilteredList(r);await d({action:"reviews-parsing-ended",status:"success",currentUrl:l,data:a})}else this.modal?this.loadMoreInModal():this.loadMoreOnPage()},async loadMoreInModal(){var a,o;if(this.loadMoreButtonError){await n(5e3),this.loadMoreButtonError.click(),await n(3e3),this.loadMoreInModal();return}const r=(a=this.modal)==null?void 0:a.querySelector(s.reviewsModalScroller),e=(o=this.modal)==null?void 0:o.querySelector(s.reviewsModalScrollerInner);if(!r||!e){await d({action:"reviews-parsing-ended",status:"error",currentUrl:l,message:"Не найден селектор для скрола в модалке"});return}r&&e&&(h(r,e.clientHeight),await n(m(3,10)*1e3),this.parseItems())},async loadMoreOnPage(){if(this.loadMoreButtonError){await n(5e3),this.loadMoreButtonError.click(),await n(3e3),this.loadMoreOnPage();return}f(),await n(m(3,10)*1e3),this.loadMoreButton&&this.loadMoreButton.click(),await n(m(3,10)*1e3),this.parseItems()},async parsingStart(){var r;await d({action:"reviews-parsing-started",status:"success",currentUrl:l}),await n(1e3),(r=this.summaryButton)==null||r.click(),await n(3e3),this.parseItems()}};chrome.runtime.onMessage.addListener(async({action:r,reviewsFilterFields:e,currentUrl:a})=>{if(!e){await d({action:"reviews-parsing-ended",status:"error",currentUrl:l,message:"Страница не получила поля фильтра"});return}r==="reviews-parsing-start"&&e&&(await n(1e3),l=a,t=e,t&&M(),y.parsingStart()),r==="get-categories"&&(await n(1e3),v())});

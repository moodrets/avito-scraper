let t=null;const n={profileName:".desktop-1r4tu1s",profileReviewsCount:".desktop-fgq05w",profileRating:'[data-marker="profile/score"]',profileSubscribers:'[data-marker="favorite-seller-counters"]',profileDeviveryInfo:".Sidebar-root-h24MJ .ProfileBadge-root-bcR8G:nth-child(2)",reviewsItem:".style-snippet-E6g8Y",reviewsItemProductName:".desktop-35wlrd",reviewsItemDateDelivery:".desktop-11ffzh3",reviewsItemRatingStars:".RatingStars-root-Edhhx .Attributes-yellow-star-PY9XT",reviewsMoreLoadButton:'[data-marker="rating-list/moreReviewsButton"]',reviewsSummaryButton:'[data-marker="profile/summary"]',reviewsModal:'[data-marker="profile-rating-detailed/popup"]',reviewsModalScroller:".desktop-y382as",reviewsModalScrollerInner:".style-root-qXsDs",reviewsMoreLoadErrorButton:'[data-marker="errorMessage/button"]'};async function c(r){await chrome.runtime.sendMessage(r)}async function m(r){return new Promise(e=>{setTimeout(()=>{e(!0)},r)})}function p(){window.scrollTo({left:0,top:document.body.scrollHeight,behavior:"smooth"})}function g(r,e){r.scrollTo({top:e,behavior:"smooth"})}async function f(r){const e=document.querySelector(n.profileName),o=document.querySelector(n.profileReviewsCount),a=document.querySelector(n.profileRating),s=document.querySelector(n.profileSubscribers),i=document.querySelector(n.profileDeviveryInfo);let u=s!=null&&s.textContent?s.textContent.split(",")[0]:null;const l={parsingDate:Date.now(),name:(e==null?void 0:e.textContent)||"Информация не найдена",rating:(a==null?void 0:a.textContent)||"Информация не найдена",reviewsCount:(o==null?void 0:o.textContent)||"Информация не найдена",subscribers:u||"Информация не найдена",deliveryInfo:(i==null?void 0:i.textContent)||"Информация не найдена",url:r.profileLink};await c({toastType:"success",toastText:"Получена информация профиля",profileInform:l})}const y={parsingEnded:!1,makeMonthNumberFromText(r){let e="";switch(r){case"января":e="01";break;case"февраля":e="02";break;case"марта":e="03";break;case"апреля":e="04";break;case"мая":e="05";break;case"июня":e="06";break;case"июля":e="07";break;case"августа":e="08";break;case"сентября":e="09";break;case"октября":e="10";break;case"ноября":e="11";break;case"декабря":e="12";break}return e},makeDateFromReviewString(r){if(r.trim()==="сегодня")return Date.now();if(r.trim()==="вчера")return new Date().setDate(new Date().getDate()-1);let e=r.split(" "),o=e[0],a=this.makeMonthNumberFromText(e[1]),s=e[2]||`${new Date().getFullYear()}`;return Date.parse(`${s} ${a} ${o}`)},makeDateFromFilterString(r){let e=r.split("."),o=e[0],a=e[1],s=e[2];return Date.parse(`${s} ${a} ${o}`)},get loadMoreButton(){return document.querySelector(n.reviewsMoreLoadButton)},get summaryButton(){return document.querySelector(n.reviewsSummaryButton)},get modal(){return document.querySelector(n.reviewsModal)},getFilteredList(r){let e=[...r];return t!=null&&t.dateFrom&&(t!=null&&t.dateTo)&&(e=e.filter(o=>{if(t!=null&&t.dateFrom&&(t!=null&&t.dateTo)&&o.date>=this.makeDateFromFilterString(t.dateFrom)&&o.date<=this.makeDateFromFilterString(t.dateTo))return o})),t!=null&&t.ratingFrom&&(t!=null&&t.ratingTo)&&(e=e.filter(o=>{if(t!=null&&t.ratingFrom&&(t!=null&&t.ratingTo)&&o.rating>=(t==null?void 0:t.ratingFrom)&&o.rating<=(t==null?void 0:t.ratingTo))return o})),t!=null&&t.productName&&(e=e.filter(o=>{let a=o.productName.toLowerCase(),s=t.productName.toLowerCase();if(a.includes(s))return o})),t!=null&&t.deliveryOnly&&(e=e.filter(o=>o.delivery)),e},async parseItems(){const r=[],e=[...document.querySelectorAll(n.reviewsItem)];if(!e.length){await c({action:"reviews-parsing-ended",toastType:"error",toastText:"Отзывы не найдены"});return}for(const o of e){const a=o.querySelectorAll(n.reviewsItemRatingStars),s=o.querySelector(n.reviewsItemProductName),i=o.querySelector(n.reviewsItemDateDelivery);let u=null,l=null,d=null;if(i!=null&&i.textContent&&(l=(i==null?void 0:i.textContent.split(",")[0])||null,u=(i==null?void 0:i.textContent.split(",")[1])||null),l&&(d=this.makeDateFromReviewString(l)),!l||!d){await c({action:"reviews-parsing-ended",toastType:"error",toastText:"Не найдены селекторы в отзывах"});break}const w={date:d||0,dateText:l||"Информация не найдена",delivery:!!u,productName:(s==null?void 0:s.textContent)||"Информация не найдена",rating:(a==null?void 0:a.length)||0};if(r.push(w),t!=null&&t.dateFrom&&w.date<=this.makeDateFromFilterString(t==null?void 0:t.dateFrom)){this.parsingEnded=!0;break}}if(this.parsingEnded){const o=this.getFilteredList(r);await c({action:"reviews-parsing-ended",toastType:"success",toastText:"Парсинг отзывов завершен",reviewsFilteredList:o})}else this.modal?this.loadMoreInModal():this.loadMoreOnPage()},async loadMoreInModal(){var o,a;const r=(o=this.modal)==null?void 0:o.querySelector(n.reviewsModalScroller),e=(a=this.modal)==null?void 0:a.querySelector(n.reviewsModalScrollerInner);(!r||!e)&&await c({action:"reviews-parsing-ended",toastType:"error",toastText:"Не найден селектор для скрола в модалке"}),r&&e&&(g(r,e.clientHeight),await m(2e3),this.parseItems())},async loadMoreOnPage(){p(),this.loadMoreButton&&this.loadMoreButton.click(),await m(3e3),this.parseItems()},async parsingStart(){var r;await c({action:"reviews-parsing-started",toastType:"success",toastText:"Парсинг отзывов запущен"}),(r=this.summaryButton)==null||r.click(),await m(4e3),this.parseItems()}};chrome.runtime.onMessage.addListener(async({action:r,filterFields:e})=>{if(!e){await c({toastType:"success",toastText:"Страница не получила поля фильтра"});return}r==="reviews-parsing-start"&&e&&(t=e,f(e),y.parsingStart())});

var T=Object.defineProperty;var N=(a,e,t)=>e in a?T(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var o=(a,e,t)=>(N(a,typeof e!="symbol"?e+"":e,t),t);function q(){let e=[...document.querySelectorAll("script")].find(t=>t.innerText.includes("__initialData__"));if(e){let t=/profileUserHash.{0,41}/gi,r=/.{0,32}$/gi,s=e.innerText.match(t)[0].match(r)[0];if(s.length===32)return s}throw new Error("Не найден profileUserHash")}async function c(a){await chrome.runtime.sendMessage(a)}async function g(a){return new Promise(e=>{setTimeout(()=>{e(!0)},a)})}function A(){let a=Math.floor(Math.random()*256-1),e=Math.floor(Math.random()*256-1),t=Math.floor(Math.random()*256-1),r=(a*299+e*587+t*114)/1e3,i=(255*299+255*587+255*114)/1e3,s=(0*299+0*587+0*114)/1e3;return{text:Math.abs(r-i)>Math.abs(r-s)?"rgb(255, 255, 255)":"rgb(0, 0, 0)",bg:`rgb(${a},${e},${t})`}}function C(a,e){return Math.floor(Math.random()*(e-a+1))+a}async function M(a){const e={profileName:'.Sidebar-root-h24MJ [data-marker*="name"]',profileReviewsCount_1:".Sidebar-root-h24MJ .desktop-fgq05w",profileReviewsCount_2:'.Sidebar-root-h24MJ [data-marker="profile"] a[role="button"]',profileRating_1:'.Sidebar-root-h24MJ [data-marker="profile/score"]',profileRating_2:'.Sidebar-root-h24MJ [data-marker="profile"] span span',profileSubscribers:'.Sidebar-root-h24MJ [data-marker="favorite-seller-counters"]',profileAsideInfoItems:".Sidebar-root-h24MJ .ProfileBadge-root-bcR8G",profileActiveAdds_1:'[data-marker="profile-tab(active)"]',profileActiveAdds_2:'#item_list_with_filters button[type="button"][data-num="0"]',profileActiveAdds_3:"#item_list_with_filters .desktop-1r4tu1s",profileCompletedAdds_1:'#item_list_with_filters button[type="button"][data-num="1"]',profileCompletedAdds_2:'[data-marker="profile-tab(closed)"]'};let t=document.querySelector(e.profileName),r=document.querySelector(e.profileReviewsCount_1),i=document.querySelector(e.profileReviewsCount_2),s=document.querySelector(e.profileRating_1),l=document.querySelector(e.profileRating_2),n=document.querySelector(e.profileSubscribers),u=[...document.querySelectorAll(e.profileAsideInfoItems)].find(P=>{var w;return(w=P.textContent)==null?void 0:w.includes("продаж")}),f=document.querySelector(e.profileActiveAdds_1),d=document.querySelector(e.profileActiveAdds_2),p=document.querySelector(e.profileActiveAdds_3),m=document.querySelector(e.profileCompletedAdds_1),h=document.querySelector(e.profileCompletedAdds_2),S=n!=null&&n.textContent?n.textContent.split(",")[0]:null,v=f!=null&&f.textContent?f.textContent.replace(/\D/g,""):null,R=d!=null&&d.textContent?d.textContent.replace(/\D/g,""):null,F=p!=null&&p.textContent?p.textContent.replace(/\D/g,""):null,y=m!=null&&m.textContent?m.textContent.replace(/\D/g,""):null,x=h!=null&&h.textContent?h.textContent.replace(/\D/g,""):null,L=s!=null&&s.textContent?s.textContent.replace(",","."):"",b=l!=null&&l.textContent?l.textContent.replace(",","."):"",D=r!=null&&r.textContent?r.textContent:null,_=i!=null&&i.textContent?i.textContent:null,I=t!=null&&t.textContent?t.textContent:null,U=u!=null&&u.textContent?u.textContent:null,k={id:Date.now(),name:I||"Информация не найдена",rating:L||b||"Информация не найдена",reviewsCount:D||_||"Информация не найдена",subscribers:S||"Информация не найдена",deliveryInfo:U||"Нет продаж с Авито Доставкой",activeAdds:v||R||F||"Информация не найдена",completedAdds:y||x||"",parsingDate:Date.now(),reviewsSortedBy:"product_name_asc",url:a,opened:!1,loading:!1,marked:!1,comment:"",color:A()};await c({action:"profile-info",status:"success",currentUrl:a,messsage:"Получена информация профиля",data:k})}class ${constructor(e,t){o(this,"currentURL");o(this,"filterFields");o(this,"offset",0);o(this,"parsingEnded",!1);o(this,"reviewsCollection",[]);this.filterFields=e,this.currentURL=t}makeDateFromFilterString(e){let t=e.split("."),r=t[0],i=t[1],s=t[2];return Date.parse(`${s} ${i} ${r}`)}makeMonthNumberFromText(e){return{января:"01",февраля:"02",марта:"03",апреля:"04",мая:"05",июня:"06",июля:"07",августа:"08",сентября:"09",октября:"10",ноября:"11",декабря:"12"}[e]}makeDateFromReviewString(e){if(e.trim()==="сегодня")return Date.now();if(e.trim()==="вчера")return new Date().setDate(new Date().getDate()-1);let t=e.split(" "),r=t[0],i=this.makeMonthNumberFromText(t[1]),s=t[2]||`${new Date().getFullYear()}`;return Date.parse(`${s} ${i} ${r}`)}makeReviewItemData(e){return{date:this.makeDateFromReviewString(e.value.rated),dateText:e.value.rated,delivery:!!e.value.deliveryTitle,productName:e.value.itemTitle,rating:e.value.score,profileUrl:this.currentURL}}getFilteredList(e){let t=[...e];return this.filterFields.dateFrom&&this.filterFields.dateTo&&(t=t.filter(r=>{if(this.filterFields.dateFrom&&this.filterFields.dateTo&&r.date>=this.makeDateFromFilterString(this.filterFields.dateFrom)&&r.date<=this.makeDateFromFilterString(this.filterFields.dateTo))return r})),this.filterFields.ratingFrom&&this.filterFields.ratingTo&&(t=t.filter(r=>{if(this.filterFields.ratingFrom&&this.filterFields.ratingTo&&r.rating>=this.filterFields.ratingFrom&&r.rating<=this.filterFields.ratingTo)return r})),this.filterFields.productName&&(t=t.filter(r=>{let i=r.productName.toLowerCase(),s=this.filterFields.productName.toLowerCase();if(i.includes(s))return r})),this.filterFields.deliveryOnly&&(t=t.filter(r=>r.delivery)),t}async apiGetReviews(e){let t=new URLSearchParams,i=`https://www.avito.ru/web/6/user/${q()}/ratings`;return e==="first"&&t.set("summary_redesign","1"),e==="next"&&(this.offset+=25,t.set("limit","25"),t.set("offset",`${this.offset}`),t.set("sortRating","date_desc"),t.set("summary_redesign","1")),i=`${i}?${t.toString()}`,(await(await fetch(i)).json()).entries.filter(u=>u.type==="rating")||[]}async parseReviews(e){await g(C(2,10)*1e3);try{let t=await this.apiGetReviews(e);this.reviewsCollection.push(...t);let r=this.makeReviewItemData(this.reviewsCollection[this.reviewsCollection.length-1]);if(this.filterFields.dateFrom&&r.date<this.makeDateFromFilterString(this.filterFields.dateFrom)&&(this.parsingEnded=!0),this.parsingEnded){let i=[];for(let l of this.reviewsCollection){let n=this.makeReviewItemData(l);i.push(n)}let s=this.getFilteredList(i);await c({action:"reviews-parsing-ended",status:"success",currentUrl:this.currentURL,data:s}),this.filterFields.closeTabs&&window.close()}else this.parseReviews("next")}catch{await c({action:"reviews-parsing-ended",status:"error",currentUrl:this.currentURL,message:"Ошибка запроса отзывов"})}finally{}}async parsingStart(){await c({action:"reviews-parsing-started",status:"success",currentUrl:this.currentURL}),this.parseReviews("first")}}class V{constructor(e,t){o(this,"SELECTORS",{profileItem:".iva-item-content-rejJg",profileItemLink:".iva-item-userInfoStep-dWwGU a",profileItemName:".iva-item-userInfoStep-dWwGU a p",profileItemRating:'.iva-item-userInfoStep-dWwGU [data-marker="seller-rating/score"]',profileItemReviewsCount:'.iva-item-userInfoStep-dWwGU [data-marker="seller-rating/summary"]',profilePrice:'[data-marker="item-price"] strong span'});o(this,"currentURL");o(this,"filterFields");o(this,"currentPageNumber",0);o(this,"profilesCollection",[]);this.filterFields=e,this.currentURL=t}getFilteredList(){let e=[...this.profilesCollection];return this.filterFields.reviewsCount&&(e=e.filter(t=>{if(t.reviewsCount>=this.filterFields.reviewsCount)return t})),this.filterFields.profileName&&(e=e.filter(t=>{let r=this.filterFields.profileName.toLowerCase(),i=t.name.toLowerCase();if(i.includes(r)||i===r)return t})),e}makeProfileItemData(e){var p;let t=e.querySelector(this.SELECTORS.profileItemLink),r=e.querySelector(this.SELECTORS.profileItemName),i=e.querySelector(this.SELECTORS.profileItemRating),s=e.querySelector(this.SELECTORS.profileItemReviewsCount),l=e.querySelector(this.SELECTORS.profilePrice),n=(p=s==null?void 0:s.textContent)==null?void 0:p.replace(/\D/g,""),u=i!=null&&i.textContent?parseFloat(i.textContent.replace(",",".")):0,f=l!=null&&l.textContent?parseFloat(l.textContent.replace(/\D/g,"")):0;return{url:t.href,name:r.textContent||"",rating:u,reviewsCount:n?+n:0,existsInDataBase:!1,price:f?+f:0}}async parseProfiles(e){await g(C(2,10)*1e3),await this.apiGetAdds(e)}async apiGetAdds(e){var r;e==="first"&&(this.currentPageNumber=+this.filterFields.pageStart),e==="next"&&(this.currentPageNumber+=1),c({action:"profiles-parsing-current-page",status:"success",currentUrl:this.currentURL,data:this.currentPageNumber});let t=new URL(this.currentURL);t.searchParams.delete("p"),this.currentPageNumber!==1&&t.searchParams.set("p",`${this.currentPageNumber}`);try{let s=await(await fetch(t.toString())).text(),l=new DOMParser().parseFromString(s,"text/html"),n=(r=l.querySelector("title"))==null?void 0:r.textContent,u=l.body.querySelectorAll(this.SELECTORS.profileItem);await c({action:"profiles-parsing-category-info",status:"success",data:n||""}),u.forEach(f=>{let d=this.makeProfileItemData(f);this.profilesCollection.push(d)}),this.currentPageNumber===+this.filterFields.pageEnd?await c({action:"profiles-parsing-ended",status:"success",currentUrl:this.currentURL,data:this.getFilteredList()}):this.parseProfiles("next")}catch{await c({action:"profiles-parsing-ended",status:"error",currentUrl:this.currentURL})}finally{}}async parsingStart(){await c({action:"profiles-parsing-started",status:"success",currentUrl:this.currentURL}),this.parseProfiles("first")}}chrome.runtime.onMessage.addListener(async({action:a,currentUrl:e,reviewsFilterFields:t,profilesFilterFields:r})=>{if(a==="profiles-parsing-start"){await g(1e3),new V(r,e).parsingStart();return}a==="reviews-parsing-start"&&t&&(await g(1e3),M(e),new $(t,e).parsingStart())});
